//全局命名空间
var dullBear={},drawEvtEumn={};(function(){dullBear.Canvas=function(a,b,c){if(isNaN(b)&&isNaN(c)&&"string"!=typeof a)return!1;this.idName=document.querySelector("#"+a);if(this.idName.getContext)this.width=b,this.height=c,this.flag=!1,this.init();else return console.log("\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u753b\u5e03\uff0c\u8bf7\u66f4\u6362\u6d4f\u89c8\u5668\uff01"),!1};dullBear.Canvas.prototype={init:function(){this.idName.setAttribute("width",this.width);this.idName.setAttribute("height",this.height);this.canvas=this.idName.getContext("2d");this.endY=this.endX=this.startY=this.startX=0;this.drawBrushType="LineFree";this.color="#ff6600";this.weight=1;this.fontSize=14;this.fontLine=16;this.family="Arial";this.colorData=[];this.pathData=[];this.maxHistoryLength=2E4;this.historyCurrent=-1;this.isDrop=!1;this.current=0;this.isPoint=!1;this.drawSetGlobalVariable({color:"#000"});this.y=this.x=0},drawSetGlobalVariable:function(a){"object"==typeof a&&(this.color=a.color||this.color,this.weight=a.weight||this.weight,this.canvas.fillStyle=this.color,this.canvas.strokeStyle=this.color,this.canvas.lineWidth=this.weight)},drawSetBrush:function(a){this.drawBrushType=a},drawMouseDown:function(a,b){if(isNaN(a)&&isNaN(b))return!1;this.flag=!0;this.startX=a;this.startY=b;this.isDrop?this.drawDropDown(a,b):this.drawDefaultDown(a,b)},drawMouseMove:function(a,b){if(isNaN(a)&&isNaN(b)||!this.flag)return!1;this.endX=a;this.endY=b;this.isDrop?this.drawDropMove(a,b):this.drawDefaultMove(a,b)},drawMouseEnd:function(){this.flag&&0!=this.endX&&0!=this.endY&&!this.isDrop&&(this.drawGetImageData(),this.pathData.push({}),this.pathData[this.pathData.length-1]["draw"+this.drawBrushType]={sx:this.startX,sy:this.startY,ex:this.endX,ey:this.endY,color:this.color,weight:this.weight});this.endY=this.endX=0;this.isPoint=this.flag=!1},drawDefaultDown:function(){switch(this.drawBrushType){case "LineFree":this.canvas.beginPath();break;case "Font":this.drawFontEvt();break;default:this.canvas.beginPath(),this.drawNextInfo=this.canvas.getImageData(0,0,this.width,this.height)}},drawDefaultMove:function(a,b){switch(this.drawBrushType){case "Line":this.drawClear();this.canvas.putImageData(this.drawNextInfo,0,0,0,0,this.width,this.height);this.drawLine(this.startX,this.startY,a,b);break;case "LineFree":this.canvas.lineTo(a,b);this.canvas.stroke();break;case "Rect":this.drawClear();this.canvas.putImageData(this.drawNextInfo,0,0,0,0,this.width,this.height);this.drawRect(this.startX,this.startY,a-this.startX,b-this.startY);break;case "RectStroke":this.drawClear();this.canvas.putImageData(this.drawNextInfo,0,0,0,0,this.width,this.height);this.drawRectStroke(this.startX,this.startY,a-this.startX,b-this.startY);break;case "Round":this.drawClear();this.canvas.putImageData(this.drawNextInfo,0,0,0,0,this.width,this.height);this.drawRound(this.startX,this.startY,Math.abs(a-this.startX));break;case "RoundStroke":this.drawClear();this.canvas.putImageData(this.drawNextInfo,0,0,0,0,this.width,this.height);this.drawRoundStroke(this.startX,this.startY,a,b);break;case "Arrow":this.drawClear(),this.canvas.putImageData(this.drawNextInfo,0,0,0,0,this.width,this.height),this.drawArrow(this.startX,this.startY,a,b)}},drawImg:function(a,b,c,e,f){if("string"!=typeof a&&isNaN(b)&&isNaN(c)&&isNaN(e)&&isNaN(f))return!1;var d=this,g=new Image;g.onload=function(){d.canvas.drawImage(g,b,c,e,f);d.drawGetImageData()};g.onerror=function(){console.log("\u56fe\u7247\u52a0\u8f7d\u9519\u8bef\uff01")};g.src=a},drawGetTxtWidth:function(a){this.canvas.font="14px Arial";return this.canvas.measureText(a).width},drawFont:function(a,b,c){this.canvas.font="14px/16px Arial";this.canvas.fillText(a,b,c)},drawLine:function(a,b,c,e){this.canvas.beginPath();this.canvas.moveTo(a,b);this.canvas.lineTo(c,e);if(this.isDrop&&0==this.endX&&0==this.endY)return this.canvas.isPointInPath(this.startX,this.startY);this.canvas.stroke()},drawRect:function(a,b,c,e){this.canvas.beginPath();this.canvas.rect(a,b,c,e);if(this.isDrop&&0==this.endX&&0==this.endY)return this.canvas.isPointInPath(this.startX,this.startY);this.canvas.fill()},drawRectStroke:function(a,b,c,e){this.canvas.beginPath();this.canvas.rect(a,b,c,e);if(this.isDrop&&0==this.endX&&0==this.endY)return this.canvas.isPointInPath(this.startX,this.startY);this.canvas.stroke()},drawRound:function(a,b,c){this.canvas.beginPath();this.canvas.arc(a,b,c,0,2*Math.PI);if(this.isDrop&&0==this.endX&&0==this.endY)return this.canvas.isPointInPath(this.startX,this.startY);this.canvas.fill()},drawRoundStroke:function(a,b,c,e){var f=parseInt(Math.abs(a-c)/2),d=parseInt(Math.abs(b-e)/2),g=f>d?f:d,k=f/g,l=d/g;a=Math.min(a,c)+f;b=Math.min(b,e)+d;this.canvas.save();this.canvas.beginPath();this.canvas.scale(k,l);this.canvas.arc(a/k,b/l,g,0,2*Math.PI);if(this.isDrop)return this.canvas.isPointInPath(this.startX,this.startY);this.canvas.stroke();this.canvas.restore()},drawArrow:function(a,b,c,e){this.canvas.beginPath();this.canvas.moveTo(a,b);this.canvas.lineTo(c,e);if(this.isDrop)return this.canvas.isPointInPath(this.startX,this.startY);this.canvas.stroke();this.canvas.closePath();this.canvas.save();this.canvas.beginPath();this.canvas.translate(c,e);a=Math.atan((c-a)/(e-b));0<=e-b?this.canvas.rotate(-a):this.canvas.rotate(math.pi-a);this.canvas.lineto(-5,-10);this.canvas.lineto(0,-5);this.canvas.lineto(5,-10);this.canvas.lineto(0,0);if(this.isdrop)return this.canvas.ispointinpath(this.startx,this.starty);this.canvas.fill();this.canvas.restore();this.canvas.closepath()},drawfontevt:function(){var="" a="this,b=$("#textFont"),c=16,e=this.width-this.startX-10,f=this.height-this.startY-10,d=null;if(b.hasClass("hide"))this.x=this.startX,this.y=this.startY,b.css({"border-color":this.color,color:this.color,"font-zie":this.fontSize+"px",width:c+"px",height:"16px",left:this.startX+"px",top:this.startY+"px","max-width":e+"px","max-height":f+"px"}).removeClass("hide"),clearTimeout(d),d=setTimeout(function(){$("#textFont").focus()},300),a=this,b.bind("input",function(){var" g="b.val(),d=g.lastIndexOf("\n"),f="",h=g;-1!=d&&(f=g.substr(0,d),h=g.substr(d,g.length));g=f;f=d="";d=[];for(s=0;s<h.length;s++)if(a.drawGetTxtWidth(h.substring(0,s))">=e){d=h.substring(0,s-1)+"\n";f=h.substring(s-1,h.length);b.val(g+d+f);break}else b.val(g+h);c=Math.max(c,a.drawGetTxtWidth(h));d=b.val().split("\n");b.css({height:d.length*a.fontLine+"px",width:c})});else{f=b.val().split("\n");for(d=0;d<f.length;d++)a.drawfont(f[d],this.x+5,this.y+(d+1)*a.fontline+2);b.css({width:c+"px",height:"16px"}).val("").unbind("input").addclass("hide");this.drawgetimagedata()}},drawaddhistory:function(a){console.log(a);this.colordata.length>=this.maxHistoryLength&&this.colorData.shift();this.colorData.push(a);this.historyCurrent=this.colorData.length-1;console.log("\u5386\u53f2\u8bb0\u5f55"+this.historyCurrent);console.log(this.colorData);console.log("\u603b\u957f\u5ea6:"+this.colorData.length)},drawPrev:function(){--this.historyCurrent;console.log("\u4e0a\u4e00\u6b65"+this.historyCurrent);if(-1==this.historyCurrent&&this.colorData.length<this.maxhistorylength)return this.drawclear(),!1;if(-1="">=this.historyCurrent)return this.historyCurrent=-1,console.log("\u6ca1\u6709\u4e0a\u4e00\u6b65\u5566\uff01"),!1;this.drawPutImageData(this.historyCurrent)},drawNext:function(){this.historyCurrent+=1;if(this.historyCurrent>=this.colorData.length)return this.historyCurrent=this.colorData.length-1,console.log("\u6ca1\u6709\u4e0b\u4e00\u6b65\u5566\uff01"),!1;this.drawPutImageData(this.historyCurrent)},drawDrop:function(){this.isDrop=!this.isDrop;console.log(this.isDrop)},drawGetImageData:function(){this.drawAddHistory(this.canvas.getImageData(0,0,this.width,this.height))},drawPutImageData:function(a){this.canvas.putImageData(this.colorData[a],0,0,0,0,this.width,this.height)},drawClear:function(){this.canvas.clearRect(0,0,this.width,this.height)},drawSavse:function(){var a=document.getElementById("myCanvas").toDataURL("image/png").replace("image/png","image/octet-stream");window.location.href=a}}})();var headHeight=$("#header").height(),footHeight=$("#footer").height(),winHeight=$(document).height()-footHeight,winWidth=$(document).width(),Canvas=new dullBear.Canvas("myCanvas",winWidth,winHeight);function choose(a){if("string"!=typeof a)return!1;$(".brushType").addClass("hide");"prev"==a?Canvas.drawPrev():"next"==a?Canvas.drawNext():"drop"==a?Canvas.drawDrop():"tool"==a?$("#canvasBrush").removeClass("hide"):"color"==a?$("#brushColorBox").removeClass("hide"):"weight"==a&&$("#brushWeightBox").removeClass("hide")}function chooseTool(a){if("string"!=typeof a)return!1;Canvas.drawSetBrush(a);$(".brushType").addClass("hide")}function chooseColor(a){if("string"!=typeof a)return!1;Canvas.drawSetGlobalVariable({color:a});$(".brushType").addClass("hide")}function chooseWeight(a){if("string"!=typeof a)return!1;Canvas.drawSetGlobalVariable({weight:a});$(".brushType").addClass("hide")}(function(){$("#myCanvas").mousemove(function(a){Canvas.drawMouseMove(a.pageX,a.pageY-headHeight,"rgba(255, 255, 0, 1)",1)}).mousedown(function(a){$(".brushType").addClass("hide");Canvas.drawMouseDown(a.pageX,a.pageY-headHeight);console.log(a.pageY)});$(window).mouseup(function(){Canvas.drawMouseEnd()});$("#tools li[data-fun]").click(function(a){a=$(this).attr("data-fun");choose(a);console.log(a)});$("#canvasBrush li[data-type]").click(function(){var a=$(this).attr("data-type");"Images"==a?(Canvas.drawImg("images/1.jpg",0,0,winWidth,winHeight),$(".brushType").addClass("hide")):chooseTool(a)});$("#brushColorBox li[data-color]").click(function(){var a=$(this).attr("data-color");chooseColor(a)});$("#brushColorBox li[data-weight]").click(function(){var a=$(this).attr("data-weight");chooseWeight(a)})})();(function(){var a=document.querySelector("#myCanvas");a.addEventListener("touchstart",function(a){a.changedTouches&&(a=a.changedTouches[a.changedTouches.length-1]);$(".brushType").addClass("hide");Canvas.drawMouseDown(a.pageX,a.pageY)});a.addEventListener("touchmove",function(a){a.preventDefault();a.changedTouches&&(a=a.changedTouches[a.changedTouches.length-1]);Canvas.drawMouseMove(a.pageX,a.pageY)});a.addEventListener("touchend",function(a){a.changedTouches&&(a=a.changedTouches[a.changedTouches.length-1]);Canvas.drawMouseEnd(a.pageX,a.pageY)});$("#tools li[data-fun]").tap(function(a){a=$(this).attr("data-fun");choose(a);console.log(a)});$("#canvasBrush li[data-type]").tap(function(){var a=$(this).attr("data-type");chooseTool(a)});$("#brushColorBox li[data-color]").tap(function(){var a=$(this).attr("data-color");chooseColor(a)});$("#brushColorBox li[data-weight]").tap(function(){var a=$(this).attr("data-weight");chooseWeight(a)})})();</this.maxhistorylength)return></f.length;d++)a.drawfont(f[d],this.x+5,this.y+(d+1)*a.fontline+2);b.css({width:c+"px",height:"16px"}).val("").unbind("input").addclass("hide");this.drawgetimagedata()}},drawaddhistory:function(a){console.log(a);this.colordata.length></=e-b?this.canvas.rotate(-a):this.canvas.rotate(math.pi-a);this.canvas.lineto(-5,-10);this.canvas.lineto(0,-5);this.canvas.lineto(5,-10);this.canvas.lineto(0,0);if(this.isdrop)return>